---
import { codeToHtml } from 'shiki';

interface Props {
	code: string;
	lang?: string;
}

const { code, lang = 'text' } = Astro.props;

let html = '';
try {
	html = await codeToHtml(code, {
		lang,
		theme: 'github-dark',
	});
} catch (error) {
	html = await codeToHtml(code, {
		lang: 'text',
		theme: 'github-dark',
	});
}

const codeId = `code-${Math.random().toString(36).substr(2, 9)}`;
---

<div class="code-block-wrapper">
	<button
		class="code-copy-button"
		data-code-id={codeId}
		aria-label="Copy code to clipboard"
		type="button"
	>
		<svg class="copy-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
			<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
		</svg>
		<svg class="check-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
			<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
		</svg>
	</button>
	<div class="code-block" id={codeId} data-code={code} set:html={html} />
</div>

<style>
	.code-block-wrapper {
		position: relative;
		margin-bottom: 1rem;
	}

	.code-block {
		border-radius: 0.75rem;
		padding: 1rem;
		font-family: ui-monospace, SFMono-Regular, 'SF Mono', Menlo, Consolas, 'Liberation Mono', monospace;
		font-size: 0.875rem;
		line-height: 1.25rem;
		overflow-x: auto;
		background-color: var(--color-bg-code);
		border: 1px solid var(--color-border);
		box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
	}

	.code-block :global(pre) {
		margin: 0;
		background: transparent !important;
		padding: 0;
	}

	.code-block :global(code) {
		display: block;
		width: 100%;
		color: var(--color-text-primary);
		font-family: ui-monospace, SFMono-Regular, 'SF Mono', Menlo, Consolas, 'Liberation Mono', monospace;
	}

	.code-block :global(.shiki) {
		background: transparent !important;
	}

	.code-copy-button {
		position: absolute;
		top: 0.75rem;
		right: 0.75rem;
		padding: 0.5rem;
		border-radius: 0.5rem;
		transition: all 0.2s ease;
		background: rgba(255, 255, 255, 0.1);
		border: 1px solid var(--color-border);
		color: var(--color-text-primary);
		cursor: pointer;
		opacity: 0.7;
		z-index: 10;
	}

	.code-copy-button:hover {
		opacity: 1;
		background: rgba(255, 255, 255, 0.15);
		border-color: var(--color-border-hover);
		transform: scale(1.05);
	}

	.code-copy-button:active {
		transform: scale(0.95);
	}

	.code-copy-button.copied {
		background: rgba(0, 255, 170, 0.2);
		border-color: var(--color-teal-bright);
		opacity: 1;
	}

	.code-copy-button svg {
		width: 1rem;
		height: 1rem;
		display: block;
	}

	.code-copy-button .check-icon {
		display: none;
	}

	.code-copy-button.copied .copy-icon {
		display: none;
	}

	.code-copy-button.copied .check-icon {
		display: block;
		color: var(--color-teal-bright);
	}

	[data-theme="light"] .code-copy-button {
		background: rgba(0, 0, 0, 0.05);
	}

	[data-theme="light"] .code-copy-button:hover {
		background: rgba(0, 0, 0, 0.1);
	}
</style>

<script>
	document.addEventListener('DOMContentLoaded', () => {
		const copyButtons = document.querySelectorAll('.code-copy-button');
		
		copyButtons.forEach(button => {
			button.addEventListener('click', async () => {
				const codeId = button.getAttribute('data-code-id');
				if (!codeId) return;
				const codeBlock = document.getElementById(codeId);
				if (!codeBlock) return;

				const code = codeBlock.getAttribute('data-code') || codeBlock.textContent || '';
				try {
					await navigator.clipboard.writeText(code);
					
					button.classList.add('copied');
					
					setTimeout(() => {
						button.classList.remove('copied');
					}, 2000);
				} catch (err) {
					console.error('Failed to copy code:', err);
				}
			});
		});
	});
</script>

